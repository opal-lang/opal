name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.25.x'
  CACHE_VERSION: v3

jobs:
  # =============================================================================
  # PHASE 1: Independent Validation (All run in parallel)
  # =============================================================================

  format-check:
    name: Format Check
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            experimental-features = nix-command flakes

      - name: Cache Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 1073741824

      - name: Check Nix formatting
        run: |
          echo "Checking Nix file formatting..."
          nix run nixpkgs#nixpkgs-fmt -- --check . || {
            echo "Nix formatting check failed. Run 'nixpkgs-fmt .' to fix."
            exit 1
          }

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.work.sum

      - name: Install gofumpt
        run: go install mvdan.cc/gofumpt@latest

      - name: Check Go formatting
        run: |
          echo "Checking Go formatting..."
          if [ "$(gofumpt -l . | wc -l)" -gt 0 ]; then
            echo "Go formatting issues found:"
            gofumpt -l .
            echo "Run 'gofumpt -w .' to fix."
            exit 1
          fi

      - name: Nix flake check (basic)
        run: |
          echo "Basic Nix flake validation..."
          nix flake check --no-build

  lint:
    name: Lint (${{ matrix.module }})
    runs-on: blacksmith-4vcpu-ubuntu-2404
    strategy:
      matrix:
        module: [core, runtime, cli]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.work.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.8.0
          working-directory: ${{ matrix.module }}
          args: --timeout=5m --verbose

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [blacksmith-4vcpu-ubuntu-2404, macos-latest, blacksmith-4vcpu-windows-2025]
        include:
          - os: blacksmith-4vcpu-ubuntu-2404
            goos: linux
            goarch: amd64
            binary_name: opal-linux-amd64
          - os: macos-latest
            goos: darwin
            goarch: amd64
            binary_name: opal-darwin-amd64
          - os: blacksmith-4vcpu-windows-2025
            goos: windows
            goarch: amd64
            binary_name: opal-windows-amd64.exe
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.work.sum

      - name: Build binary (Linux/macOS)
        if: matrix.goos != 'windows'
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          echo "Building opal for ${{ matrix.goos }}/${{ matrix.goarch }}..."
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          go build -ldflags="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
            -o ${{ matrix.binary_name }} \
            ./cli

      - name: Build binary (Windows)
        if: matrix.goos == 'windows'
        shell: pwsh
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          Write-Host "Building opal for $env:GOOS/$env:GOARCH..."
          $version = (git describe --tags --always --dirty) 2>$null
          if (-not $version) { $version = "dev" }
          $buildTime = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $ldflags = "-s -w -X main.Version=$version -X main.BuildTime=$buildTime"
          go build -ldflags $ldflags -o "${{ matrix.binary_name }}" ./cli

      - name: Compile all modules (Windows)
        if: matrix.goos == 'windows'
        shell: pwsh
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          Write-Host "Compile-checking all modules and tests for windows/$env:GOARCH..."
          go test -run TestDoesNotExist -count=1 ./core/... ./runtime/... ./cli/...

      - name: Test cancellation path (Windows)
        if: matrix.goos == 'windows'
        shell: pwsh
        run: |
          go test ./core/decorator -run TestLocalSessionAlreadyCanceledContext -count=1

      - name: Test binary (Linux/macOS)
        if: matrix.goos != 'windows'
        run: |
          echo "Testing built binary..."
          ./${{ matrix.binary_name }} --help

          echo 'fun test = echo "Binary test successful"' > test.opl
          ./${{ matrix.binary_name }} --dry-run -f test.opl test

      - name: Test binary (Windows)
        if: matrix.goos == 'windows'
        shell: pwsh
        run: |
          Write-Host "Testing built binary..."
          & ".\${{ matrix.binary_name }}" --help
          Set-Content -Path test.opl -Value 'fun test = echo "Binary test successful"'
          & ".\${{ matrix.binary_name }}" --dry-run -f test.opl test

      - name: Verify PowerShell 7+ (Windows required)
        if: matrix.goos == 'windows'
        shell: pwsh
        run: |
          if ($PSVersionTable.PSVersion.Major -lt 7) {
            Write-Error "PowerShell 7+ is required on Windows runners"
            exit 1
          }

      - name: System smoke (Windows cmd shell, best-effort)
        if: matrix.goos == 'windows'
        continue-on-error: true
        shell: pwsh
        run: |
          Set-Content -Path smoke-cmd.opl -Value 'fun hello = echo %ComSpec%'
          $env:OPAL_SHELL = "cmd"
          $output = & ".\${{ matrix.binary_name }}" -f smoke-cmd.opl hello
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          if ($output -notmatch "cmd.exe") {
            Write-Error "Expected cmd shell output, got: $output"
            exit 1
          }

      - name: System smoke (Windows pwsh shell)
        if: matrix.goos == 'windows'
        shell: pwsh
        run: |
          Set-Content -Path smoke-pwsh.opl -Value "fun hello = Write-Output `$PSVersionTable.PSVersion.Major"
          $env:OPAL_SHELL = "pwsh"
          $output = & ".\${{ matrix.binary_name }}" -f smoke-pwsh.opl hello
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          if ($output -notmatch "[0-9]") {
            Write-Error "Expected pwsh shell output, got: $output"
            exit 1
          }

      - name: System smoke (Windows bash shell, best-effort)
        if: matrix.goos == 'windows'
        continue-on-error: true
        shell: pwsh
        run: |
          if (Get-Command bash -ErrorAction SilentlyContinue) {
            Set-Content -Path smoke-bash.opl -Value 'fun hello = echo $BASH_VERSION'
            $env:OPAL_SHELL = "bash"
            $output = & ".\${{ matrix.binary_name }}" -f smoke-bash.opl hello
            if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
            if ($output -notmatch "[0-9]") {
              Write-Error "Expected bash shell output, got: $output"
              exit 1
            }
          } else {
            Write-Host "bash not present on runner; skipping bash smoke test"
          }

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.binary_name }}
          path: ${{ matrix.binary_name }}

  nix-development:
    name: Nix Development (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [blacksmith-4vcpu-ubuntu-2404, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            experimental-features = nix-command flakes

      - name: Cache Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 1073741824

      - name: Test development shell
        run: |
          echo "Testing Nix development shell..."
          nix develop --command echo "Development shell provides dependencies!"

      - name: Verify Go tools in Nix shell
        run: |
          echo "Verifying Go tools are available in Nix shell..."
          nix develop --command go version
          nix develop --command gofumpt --version || echo "gofumpt not required in shell"

      - name: Cross-check Windows compile in Nix shell
        if: matrix.os == 'blacksmith-4vcpu-ubuntu-2404'
        run: |
          echo "Cross-checking Windows build target from Linux Nix shell..."
          nix develop --command bash -lc 'GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go test -run TestDoesNotExist -count=1 -exec=true ./core/... ./runtime/... ./cli/...'

  # =============================================================================
  # PHASE 2: Module Testing (All run in parallel after lint)
  # =============================================================================

  test:
    name: Test (${{ matrix.module }})
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [lint]
    timeout-minutes: 15
    permissions:
      contents: read
      actions: read
    strategy:
      fail-fast: false
      matrix:
        module: [core, runtime, cli]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            experimental-features = nix-command flakes

      - name: Cache Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 1073741824

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.temp }}/go-build
            ${{ runner.temp }}/go-mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run module tests
        env:
          TMPDIR: ${{ runner.temp }}/go-tmp
          GOTMPDIR: ${{ runner.temp }}/go-tmp
          GOCACHE: ${{ runner.temp }}/go-build
          GOMODCACHE: ${{ runner.temp }}/go-mod
        run: |
          set -euo pipefail
          mkdir -p "$TMPDIR" "$GOCACHE" "$GOMODCACHE"
          nix develop -c bash -c '
            echo "Running ${{ matrix.module }} module tests..."
            cd ${{ matrix.module }}
            go test -v -race -coverprofile=../coverage-${{ matrix.module }}.out -covermode=atomic ./...
          '

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.module }}
          path: coverage-${{ matrix.module }}.out

      - name: Test CLI build and basic functionality
        if: matrix.module == 'cli'
        run: |
          set -euo pipefail
          nix develop -c bash -c '
            echo "Testing CLI build and interpreter mode..."
            cd cli
            go build -o opal .
            ./opal --help
            echo '\''fun test = echo "CI test successful"'\'' > test.opl
            ./opal --dry-run -f test.opl test
          '

  # =============================================================================
  # PHASE 3: Aggregation (After all tests)
  # =============================================================================

  aggregate-coverage:
    name: Aggregate Coverage
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-artifacts/

      - name: Merge coverage reports
        run: |
          set -euo pipefail
          echo "Merging coverage reports..."
          find coverage-artifacts/ -name "*.out" -exec cp {} . \;
          echo "mode: atomic" > coverage.out
          tail -n +2 coverage-*.out | grep -v "mode: atomic" >> coverage.out || true

      - name: Upload merged coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: Archive merged coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-merged
          path: coverage.out

  # =============================================================================
  # SUMMARY: Collect all results
  # =============================================================================

  summary:
    name: CI Summary
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [format-check, lint, build, nix-development, test, aggregate-coverage]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          set -euo pipefail
          echo "CI Pipeline Summary"
          echo "================================"

          jobs=(
            "${{ needs.format-check.result }}:Format Check"
            "${{ needs.lint.result }}:Lint"
            "${{ needs.build.result }}:Build"
            "${{ needs.nix-development.result }}:Nix Development"
            "${{ needs.test.result }}:Test Modules"
            "${{ needs.aggregate-coverage.result }}:Coverage Report"
          )

          all_passed=true
          for job in "${jobs[@]}"; do
            status="${job%%:*}"
            name="${job##*:}"
            case $status in
              success) echo "âœ… $name" ;;
              failure) echo "âŒ $name"; all_passed=false ;;
              cancelled) echo "â¹ï¸  $name"; all_passed=false ;;
              skipped) echo "â­ï¸  $name" ;;
              *) echo "â“ $name ($status)"; all_passed=false ;;
            esac
          done

          echo "================================"
          if [ "$all_passed" = true ]; then
            echo "ðŸŽ‰ All CI jobs passed successfully!"
          else
            echo "âŒ Some CI jobs failed. Check the logs above."
            exit 1
          fi

  # =============================================================================
  # LATEST BUILDS (only on main/master)
  # =============================================================================

  latest-builds:
    name: Latest Development Builds
    runs-on: blacksmith-4vcpu-ubuntu-2404
    needs: [summary]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare development builds
        run: |
          echo "Preparing latest development builds..."
          mkdir -p latest/

          find artifacts/ -name 'opal-*' -type f -exec cp {} latest/ \;

          echo "Built from commit: ${{ github.sha }}" > latest/build-info.txt
          echo "Built at: $(date -u)" >> latest/build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> latest/build-info.txt

      - name: Archive latest builds
        uses: actions/upload-artifact@v4
        with:
          name: latest-dev-builds
          path: latest/
          retention-days: 30

  # =============================================================================
  # RELEASE (only when tags are pushed)
  # =============================================================================

  release:
    name: Create Release
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: go.work.sum

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Build release binaries
        run: |
          echo "Building release binaries for ${{ steps.version.outputs.version }}..."

          platforms=(
            "linux/amd64"
            "linux/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "windows/amd64"
          )

          mkdir -p release/

          for platform in "${platforms[@]}"; do
            GOOS=${platform%/*}
            GOARCH=${platform#*/}

            echo "Building for $GOOS/$GOARCH..."

            if [ "$GOOS" = "windows" ]; then
              BINARY_NAME="opal-$GOOS-$GOARCH.exe"
            else
              BINARY_NAME="opal-$GOOS-$GOARCH"
            fi

            CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" go build \
              -ldflags="-s -w -X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              -o "release/$BINARY_NAME" \
              ./cli
          done

      - name: Create checksums
        run: |
          echo "Creating checksums..."
          cd release/

          for file in opal-*; do
            if [ -f "$file" ]; then
              sha256sum "$file" >> checksums.txt
            fi
          done

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            release/opal-*
            release/checksums.txt
          generate_release_notes: true
          body: |
            ## ðŸš€ Devcmd ${{ steps.version.outputs.version }}

            **Declarative CLI Tool - Interpreter Mode**

            ### âœ… Available Features
            - **Interpreter Mode**: Run commands directly with `opal run <command>`
            - **Shell Operators**: Support for `&&`, `||`, `|`, `>>`
            - **Variable Substitution**: `@var(NAME)` syntax
            - **Plan Generation**: `--dry-run` mode
            - **Standardized Flags**: `--quiet`, `--verbose`, `--ci`, etc.

            ### ðŸ“¦ Downloads
            - **Linux (x64)**: `opal-linux-amd64`
            - **Linux (ARM64)**: `opal-linux-arm64`
            - **macOS (Intel)**: `opal-darwin-amd64`
            - **macOS (Apple Silicon)**: `opal-darwin-arm64`
            - **Windows (x64)**: `opal-windows-amd64.exe`

            ### ðŸš§ Coming Soon
            - Standalone CLI generation (Generator Mode)
            - Advanced decorators (@workdir, @timeout, @parallel)

            ### âœ… Verification
            Verify downloads with SHA256 checksums in `checksums.txt`.

            ### ðŸ“š Documentation
            See README.md for usage instructions and examples.
