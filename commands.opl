# Devcmd Development Commands - Modular Architecture
# Multi-module project with clean separation of concerns and dependency hierarchy

# =============================================================================
# PROJECT CONFIGURATION
# =============================================================================

var PROJECT = "opal"
var VERSION = "$(git describe --tags --always --dirty 2>/dev/null || echo 'dev')"
var BUILD_TIME = "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
var GO_VERSION = "1.24.3"

# =============================================================================
# ğŸ“¦ CORE MODULE - Foundation (no dependencies)
# =============================================================================

# Core module testing
core-test: @workdir("core") { 
    @log("ğŸ§ª Testing core module...")
    go test -v ./... 
}

core-test-coverage: @workdir("core") { 
    @log("ğŸ“Š Testing core module with coverage...")
    go test -race -coverprofile=../coverage-core.out -covermode=atomic ./... 
}

# Core module code quality
core-lint: @workdir("core") { 
    @log("ğŸ” Linting core module...")
    command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./...
}

core-format: @workdir("core") { 
    @log("ğŸ“ Formatting core module...")
    command -v gofumpt >/dev/null 2>&1 && gofumpt -w . || go fmt ./...
}

# Core module utilities
core-clean: @workdir("core") { 
    @log("ğŸ§¹ Cleaning core module...")
    go clean -cache -testcache
}

core-deps: @workdir("core") { 
    @log("ğŸ“¦ Managing core module dependencies...")
    go mod download
    go mod tidy
}

# Complete core module CI workflow
core-ci: {
    @log("ğŸ§ª Core module CI workflow...")
    @cmd(core-format)
    @cmd(core-lint)
    @cmd(core-test-coverage)
    @log("âœ… Core module CI complete!")
}

# =============================================================================
# ğŸ—ï¸ CODEGEN MODULE - Code Generation Utilities (depends on core)
# =============================================================================

# Codegen module testing
codegen-test: @workdir("codegen") { 
    @log("ğŸ—ï¸ Testing codegen module...")
    go test -v ./... 
}

codegen-test-coverage: @workdir("codegen") { 
    @log("ğŸ“Š Testing codegen module with coverage...")
    go test -race -coverprofile=../coverage-codegen.out -covermode=atomic ./... 
}

# Codegen module code quality
codegen-lint: @workdir("codegen") { 
    @log("ğŸ” Linting codegen module...")
    command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./...
}

codegen-format: @workdir("codegen") { 
    @log("ğŸ“ Formatting codegen module...")
    command -v gofumpt >/dev/null 2>&1 && gofumpt -w . || go fmt ./...
}

# Codegen module utilities
codegen-clean: @workdir("codegen") { 
    @log("ğŸ§¹ Cleaning codegen module...")
    go clean -cache -testcache
}

codegen-deps: @workdir("codegen") { 
    @log("ğŸ“¦ Managing codegen module dependencies...")
    go mod download
    go mod tidy
}

# Complete codegen module CI workflow (includes dependency validation)
codegen-ci: {
    @log("ğŸ—ï¸ Codegen module CI workflow...")
    @cmd(core-test)          # Ensure dependency is good
    @cmd(codegen-format)
    @cmd(codegen-lint)
    @cmd(codegen-test-coverage)
    @log("âœ… Codegen module CI complete!")
}

# =============================================================================
# âš¡ RUNTIME MODULE - Decorators & Execution (depends on core)
# =============================================================================

# Runtime module testing
runtime-test: @workdir("runtime") { 
    @log("âš¡ Testing runtime module...")
    go test -v ./... 
}

runtime-test-coverage: @workdir("runtime") { 
    @log("ğŸ“Š Testing runtime module with coverage...")
    go test -race -coverprofile=../coverage-runtime.out -covermode=atomic ./... 
}

# Runtime module code quality
runtime-lint: @workdir("runtime") { 
    @log("ğŸ” Linting runtime module...")
    command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./...
}

runtime-format: @workdir("runtime") { 
    @log("ğŸ“ Formatting runtime module...")
    command -v gofumpt >/dev/null 2>&1 && gofumpt -w . || go fmt ./...
}

# Runtime module utilities
runtime-clean: @workdir("runtime") { 
    @log("ğŸ§¹ Cleaning runtime module...")
    go clean -cache -testcache
}

runtime-deps: @workdir("runtime") { 
    @log("ğŸ“¦ Managing runtime module dependencies...")
    go mod download
    go mod tidy
}

# Complete runtime module CI workflow (includes dependency validation)
runtime-ci: {
    @log("âš¡ Runtime module CI workflow...")
    @cmd(core-test)          # Ensure dependency is good
    @cmd(runtime-format)
    @cmd(runtime-lint)
    @cmd(runtime-test-coverage)
    @log("âœ… Runtime module CI complete!")
}

# =============================================================================
# ğŸ§° TESTING MODULE - Test Utilities (depends on core + runtime)
# =============================================================================

# Testing module testing
testing-test: @workdir("testing") { 
    @log("ğŸ§° Testing testing module...")
    go test -v ./... 
}

testing-test-coverage: @workdir("testing") { 
    @log("ğŸ“Š Testing testing module with coverage...")
    go test -race -coverprofile=../coverage-testing.out -covermode=atomic ./... 
}

# Testing module code quality
testing-lint: @workdir("testing") { 
    @log("ğŸ” Linting testing module...")
    command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./...
}

testing-format: @workdir("testing") { 
    @log("ğŸ“ Formatting testing module...")
    command -v gofumpt >/dev/null 2>&1 && gofumpt -w . || go fmt ./...
}

# Testing module utilities
testing-clean: @workdir("testing") { 
    @log("ğŸ§¹ Cleaning testing module...")
    go clean -cache -testcache
}

testing-deps: @workdir("testing") { 
    @log("ğŸ“¦ Managing testing module dependencies...")
    go mod download
    go mod tidy
}

# Complete testing module CI workflow (includes dependency validation)
testing-ci: {
    @log("ğŸ§° Testing module CI workflow...")
    @cmd(core-test)          # Ensure dependencies are good
    @cmd(runtime-test)
    @cmd(testing-format)
    @cmd(testing-lint)
    @cmd(testing-test-coverage)
    @log("âœ… Testing module CI complete!")
}

# =============================================================================
# ğŸš€ CLI MODULE - Main Application (depends on all modules)
# =============================================================================

# CLI module testing
cli-test: @workdir("cli") { 
    @log("ğŸš€ Testing CLI module...")
    go test -v ./... 
}

cli-test-coverage: @workdir("cli") { 
    @log("ğŸ“Š Testing CLI module with coverage...")
    go test -race -coverprofile=../coverage-cli.out -covermode=atomic ./... 
}

# CLI module code quality
cli-lint: @workdir("cli") { 
    @log("ğŸ” Linting CLI module...")
    command -v golangci-lint >/dev/null 2>&1 && golangci-lint run --timeout=3m || go vet ./...
}

cli-format: @workdir("cli") { 
    @log("ğŸ“ Formatting CLI module...")
    command -v gofumpt >/dev/null 2>&1 && gofumpt -w . || go fmt ./...
}

# CLI module utilities
cli-clean: @workdir("cli") { 
    @log("ğŸ§¹ Cleaning CLI module...")
    go clean -cache -testcache
}

cli-deps: @workdir("cli") { 
    @log("ğŸ“¦ Managing CLI module dependencies...")
    go mod download
    go mod tidy
}

# Component-specific CLI tests
cli-test-lexer: @workdir("cli") { go test -v ./internal/lexer }
cli-test-parser: @workdir("cli") { go test -v ./internal/parser }
cli-test-engine: @workdir("cli") { go test -v ./internal/engine }

# Complete CLI module CI workflow (includes all dependency validation)
cli-ci: {
    @log("ğŸš€ CLI module CI workflow...")
    @cmd(core-test)          # Ensure all dependencies are good
    @cmd(runtime-test)
    @cmd(testing-test)
    @cmd(cli-format)
    @cmd(cli-lint)
    @cmd(cli-test-coverage)
    @log("âœ… CLI module CI complete!")
}

# =============================================================================
# ğŸ”„ GLOBAL ORCHESTRATION - Project-wide Commands
# =============================================================================

# Quick setup for new contributors
setup: {
    @log("ğŸ”§ Setting up @var(PROJECT) development environment...")
    @log("ğŸ“¦ Downloading Go dependencies for all modules...")
    @parallel {
        @cmd(core-deps)
        @cmd(codegen-deps)
        @cmd(runtime-deps)
        @cmd(testing-deps)
        @cmd(cli-deps)
    }
    go work sync
    @log("âœ… Setup complete! Run 'dev ci' to verify everything works.")
}

# Test all modules respecting dependency hierarchy
test: {
    @log("ğŸ§ª Testing all modules with dependency awareness...")
    @cmd(core-test)           # Foundation
    @cmd(codegen-test)        # Depends on core
    @cmd(runtime-test)        # Depends on core
    @cmd(testing-test)        # Depends on core + runtime  
    @cmd(cli-test)            # Depends on all
    @log("âœ… All module tests passed!")
}

# Test all modules with coverage
test-coverage: {
    @log("ğŸ“Š Running tests with coverage across all modules...")
    @cmd(core-test-coverage)
    @cmd(codegen-test-coverage)
    @cmd(runtime-test-coverage)
    @cmd(testing-test-coverage)
    @cmd(cli-test-coverage)
    @cmd(coverage-reports)
    @log("âœ… Coverage testing complete!")
}

# Generate coverage reports (only called after coverage tests)
coverage-reports: {
    @log("ğŸ“Š Merging coverage reports...")
    command -v gocovmerge >/dev/null 2>&1 && gocovmerge coverage-*.out > coverage.out && rm coverage-*.out || @log("âš ï¸  gocovmerge not available")
    command -v go >/dev/null 2>&1 && go tool cover -html=coverage.out -o coverage.html && @log("ğŸ“Š Coverage report: coverage.html")
}

# Format all modules
format: {
    @log("ğŸ“ Formatting all code across modules...")
    @parallel {
        @cmd(core-format)
        @cmd(codegen-format)
        @cmd(runtime-format)
        @cmd(testing-format)
        @cmd(cli-format)
    }
    # Also format Nix files
    command -v nixpkgs-fmt >/dev/null 2>&1 && find . -name '*.nix' -exec nixpkgs-fmt {} + || @log("âš ï¸  nixpkgs-fmt not available")
    @log("âœ… All code formatted!")
}

# Lint all modules
lint: {
    @log("ğŸ” Running linters across all modules...")
    @parallel {
        @cmd(core-lint)
        @cmd(codegen-lint)
        @cmd(runtime-lint)
        @cmd(testing-lint)
        @cmd(cli-lint)
    }
    @log("âœ… Linting complete!")
}

# Clean all modules
clean: {
    @log("ğŸ§¹ Cleaning generated files and artifacts...")
    @parallel {
        @cmd(core-clean)
        @cmd(codegen-clean)
        @cmd(runtime-clean)
        @cmd(testing-clean)
        @cmd(cli-clean)
    }
    rm -f @var(PROJECT) coverage-core.out coverage-codegen.out coverage-runtime.out coverage-testing.out coverage-cli.out coverage.out coverage.html
    rm -rf result result-* build/ artifacts/
    @log("âœ… Cleanup complete")
}

# Build the CLI (with full validation)
build: {
    @log("ğŸ”¨ Building @var(PROJECT) CLI...")
    @log("ğŸ§ª Running full CI to ensure quality...")
    @cmd(ci)
    @log("ğŸ”¨ Building binary...")
    @workdir("cli") { go build -ldflags="-s -w -X main.Version=@var(VERSION) -X main.BuildTime=@var(BUILD_TIME)" -o ../@var(PROJECT) ./main.go }
    @log("âœ… Built: ./@var(PROJECT)")
}

# Full CI workflow
ci: {
    @log("ğŸ”„ Full project CI workflow...")
    @cmd(core-ci)
    @cmd(codegen-ci)
    @cmd(runtime-ci)
    @cmd(testing-ci)
    @cmd(cli-ci)
    @log("ğŸ‰ Full project CI complete!")
}

# Quick development iteration
dev-quick: {
    @log("âš¡ Quick development checks...")
    @cmd(format)
    @cmd(test)
    @log("âœ… Quick checks passed!")
}

# =============================================================================
# ğŸ“¦ NIX INTEGRATION  
# =============================================================================

# Build with Nix
nix-build: {
    @log("ğŸ“¦ Building with Nix...")
    nix build .#@var(PROJECT) --print-build-logs
    @log("âœ… Nix build complete")
}

# Comprehensive Nix validation
nix-check: {
    @log("ğŸ” Running comprehensive Nix validation...")
    nix flake check --print-build-logs
    @log("âœ… Nix validation passed")
}

# Test all example CLIs
test-examples: {
    @log("ğŸ¯ Testing example CLIs...")
    @parallel {
        nix build .#basicDev --print-build-logs
        nix build .#webDev --print-build-logs
        nix build .#goProject --print-build-logs
    }
    @log("Testing example functionality...")
    @parallel {
        nix run .#basicDev -- --help >/dev/null
        nix run .#webDev -- --help >/dev/null
        nix run .#goProject -- --help >/dev/null
    }
    @log("âœ… Example CLI tests passed!")
}

# Release preparation with comprehensive testing
release: @timeout(10m) {
    @log("ğŸ“¦ Running release preparation workflow...")
    @cmd(clean)
    @cmd(setup)
    @cmd(ci)
    @cmd(test-examples)
    @cmd(format)
    @log("ğŸ“‹ Release checklist complete!")
    @log("ğŸš€ Ready for release!")
}

# =============================================================================
# ğŸ“Š PROJECT STATUS & UTILITIES
# =============================================================================

# Show detailed project information
info: {
    @log(`ğŸ“Š @var(PROJECT) Multi-Module Project Status
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Project: @var(PROJECT)
Version: @var(VERSION)
Build time: @var(BUILD_TIME)
Go version: @var(GO_VERSION)

Module Dependency Hierarchy:
  core/     - Foundation (AST, types, errors)
  â”œâ”€â”€ runtime/  - Decorators and execution contexts
  â”œâ”€â”€ testing/  - Test utilities and frameworks
  â””â”€â”€ cli/      - Main CLI application

Statistics:
  Go source files: $(find . -name '*.go' | wc -l)
  Test files: $(find . -name '*_test.go' | wc -l)
  Modules: $(find . -name 'go.mod' | wc -l)

Git status:`)
    git status --porcelain | head -5 || @log("Not a git repository")
}

# Quick alias for info
status: @cmd(info)

# =============================================================================
# ğŸ“‹ HELP & DOCUMENTATION
# =============================================================================

# Show comprehensive help
help: @log(`{bold}{cyan}ğŸ”§ Devcmd Multi-Module Development Commands{/cyan}{/bold}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{bold}{green}ğŸš€ Global Commands:{/green}{/bold}
  {yellow}setup{/yellow}          - Set up development environment
  {yellow}build{/yellow}          - Build CLI (with full validation)
  {yellow}ci{/yellow}             - Full project CI workflow
  {yellow}test{/yellow}           - Test all modules (dependency order)
  {yellow}test-coverage{/yellow}  - Tests with coverage reports
  {yellow}format{/yellow}         - Format all code
  {yellow}lint{/yellow}           - Run all linters
  {yellow}clean{/yellow}          - Clean artifacts and caches

{bold}{blue}ğŸ“¦ Module-Specific Commands:{/blue}{/bold}
  {yellow}core-ci{/yellow}        - Complete core module workflow
  {yellow}codegen-ci{/yellow}     - Complete codegen module workflow
  {yellow}runtime-ci{/yellow}     - Complete runtime module workflow
  {yellow}testing-ci{/yellow}     - Complete testing module workflow
  {yellow}cli-ci{/yellow}         - Complete CLI module workflow

{bold}{magenta}ğŸ§ª Module Testing:{/magenta}{/bold}
  {yellow}[module]-test{/yellow}           - Test specific module
  {yellow}[module]-test-coverage{/yellow}  - Test with coverage
  {yellow}[module]-lint{/yellow}           - Lint specific module
  {yellow}[module]-format{/yellow}         - Format specific module

{bold}{cyan}ğŸ“¦ Nix Integration:{/cyan}{/bold}
  {yellow}nix-build{/yellow}      - Build with Nix
  {yellow}nix-check{/yellow}      - Comprehensive Nix validation
  {yellow}test-examples{/yellow}  - Test example CLIs

{bold}{green}ğŸ”„ Workflows:{/green}{/bold}
  {yellow}dev-quick{/yellow}      - Fast development iteration
  {yellow}release{/yellow}        - Release preparation

{bold}{blue}ğŸ“Š Utilities:{/blue}{/bold}
  {yellow}info{/yellow}           - Show project status
  {yellow}status{/yellow}         - Show project status (alias)
  {yellow}help{/yellow}           - Show this help

{dim}Module hierarchy: core â†’ runtime â†’ testing â†’ cli{/dim}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`)